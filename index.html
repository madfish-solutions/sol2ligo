<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Solidity to LIGO compiler</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div class="nav">
      <a
        href="https://madfish-solutions.github.io/sol2ligo/"
        class="nav_selected"
        >Ligo</a
      >
      <div class="example_selector">
        <span id="load_msg">
          Need some time to load. Loading...
        </span>
        <select id="src_select"> </select>
      </div>
    </div>
    <div class="code">
      <div class="code-wrapper">
        <div class="code-tabs">
          <div class="code-tab active" style="border-left: 0;">
            Solidity
          </div>
        </div>
        <div class="code-inner" id="solidity_container"></div>
      </div>
      <!-- <div class="divider"></div> -->
      <!-- <div id="ligo_dst_wrap"> -->
      <div class="code-wrapper">
        <div class="code-tabs" id="outputs">
          <div class="code-tab active" id="pascaligo">
            Pascaligo
          </div>
          <div class="code-tab" id="output">
            Output 2
          </div>
          <div class="code-tab" id="logs">
            Errors
          </div>
        </div>
        <div
          style="border-left: 1px solid black"
          class="code-inner"
          id="ligo_container"
        ></div>
      </div>
      <!-- <pre id="ligo_dst"></pre> -->
      <!-- </div> -->
      <!-- <div class="minibutton" id="compile_btn">Compiling...</div> -->
    </div>
    <script src="web/solc/soljson.js"></script>
    <script src="web/solc/sol_wrapper.js"></script>
    <script src="web/common/fy.js"></script>
    <script src="web/common/codegen.js"></script>
    <script src="web/lib/config.js"></script>
    <script src="web/common/type.js"></script>
    <script src="web/lib/type_safe.js"></script>
    <script src="web/common/ast4gen.js"></script>
    <script src="web/lib/ast.js"></script>
    <script src="web/lib/solidity_to_ast4gen.js"></script>
    <script src="web/lib/translate_var_name.js"></script>
    <script src="web/lib/translate_ligo.js"></script>
    <script src="web/lib/translate_ligo_default_state.js"></script>
    <script src="web/lib/type_inference.js"></script>
    <script src="web/lib/ast_transform.js"></script>
    <script src="web/example_list.js"></script>
    <!-- MONACO EDITOR -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"
    ></script>
    <script>
      // const outputNode = document.querySelector("#ligo_dst");
      const compileBtnNode = document.querySelector("#compile_btn");

      document.querySelector("#load_msg").innerText =
        "Very experimental. Use it at your own RISK.";

      function compile(code) {
        return new Promise((res, rej) => {
          try {
            const solidity_ast = ast_gen(code);
            let ast = solidity_to_ast4gen.gen(solidity_ast);
            ast = ast_transform.ligo_pack(ast);
            ast = type_inference.gen(ast);
            const result = translate_ligo.gen(ast);
            res(result);
          } catch (err) {
            rej(err);
          }
        });
      }

      window.compile = compile;
    </script>

    <script>
      const monacoCdnMin =
        "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min";

      require.config({
        paths: { vs: `${monacoCdnMin}/vs` }
      });

      // Before loading vs/editor/editor.main, define a global MonacoEnvironment that overwrites
      // the default worker url location (used when creating WebWorkers). The problem here is that
      // HTML5 does not allow cross-domain web workers, so we need to proxy the instantiation of
      // a web worker through a same-domain script
      window.MonacoEnvironment = {
        getWorkerUrl: function(workerId, label) {
          return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
        self.MonacoEnvironment = {
          baseUrl: '${monacoCdnMin}'
        };
        importScripts('${monacoCdnMin}/vs/base/worker/workerMain.js');`)}`;
        }
      };

      require(["vs/editor/editor.main"], () => {
        const overlayWidget = {
          domNode: null,
          getId: function() {
            return "my.overlay.widget";
          },
          getDomNode: function() {
            if (!this.domNode) {
              this.domNode = document.createElement("div");
              this.domNode.classList.add("minibutton");
              this.domNode.innerHTML = "Compiling...";
              this.domNode.style.position = "absolute";
              this.domNode.style.right = "20px";
              this.domNode.style.top = "10px";
              this.domNode.style.zIndex = "20";
            }
            return this.domNode;
          },
          getPosition: function() {
            return null;
          },
          loading() {
            if (!this.domNode) return;
            this.domNode.innerHTML = "Compiling...";
            this.domNode.style.display = "block";
            this.domNode.style.background = "#fff";
            this.domNode.style.color = "black";
          },
          success() {
            if (!this.domNode) return;
            this.domNode.style.display = "none";
          },
          error() {
            if (!this.domNode) return;
            this.domNode.innerHTML = "ERROR!!!";
            this.domNode.style.color = "white";
            this.domNode.style.background = "#faa";
          }
        };

        const data = {
          sol: { model: null, state: null },
          pascaligo: { model: null, state: null },
          output: { model: null, state: null },
          logs: { model: null, state: null }
        };

        data.sol.model = monaco.editor.createModel(example_list[0].code, "sol");
        data.pascaligo.model = monaco.editor.createModel("", "pascaligo");
        data.output.model = monaco.editor.createModel("OUTPUTS", "text");
        data.logs.model = monaco.editor.createModel("LOGS", "text");

        const opts = {
          tabSize: "2",
          automaticLayout: true,
          theme: "vs-dark",
          wordWrap: "on",
          minimap: {
            enabled: false
          }
        };

        const solidityEditor = monaco.editor.create(
          document.getElementById("solidity_container"),
          {
            model: data.sol.model,
            ...opts
          }
        );

        const outputEditor = monaco.editor.create(
          document.getElementById("ligo_container"),
          {
            model: data.pascaligo.model,
            ...opts,
            readOnly: true
          }
        );

        solidityEditor.addOverlayWidget(overlayWidget);

        const selectNode = document.querySelector("#src_select");
        const jl_list = example_list.map(
          ({ title }) => `<option>${title}</option>`
        );
        selectNode.innerHTML = jl_list.join("");
        selectNode.onchange = e => {
          const example = example_list.find(ex => ex.title === e.target.value);
          data.sol.model.setValue(example.code);
        };

        let timeout = null;
        function onChange(code) {
          if (timeout) clearTimeout(timeout);
          overlayWidget.loading();
          timeout = setTimeout(() => {
            timeout = null;

            compile(code)
              .then(c => {
                data.pascaligo.model.setValue(c);
                data.logs.model.setValue("");
                overlayWidget.success();
              })
              .catch(err => {
                console.dir(err);
                if (data.logs.model) data.logs.model.setValue(err.stack);
                overlayWidget.error();
              });
          }, 100);
        }

        onChange(solidityEditor.getValue());

        solidityEditor.onDidChangeModelContent(_e => {
          const code = solidityEditor.getValue();

          onChange(code);
        });

        function onChangeTab(fromId, toId) {
          console.log(event);
        }

        const outputsNode = document.getElementById("outputs");
        Array.from(outputsNode.children).forEach(node => {
          node.onclick = () => {
            outputsNode.querySelector(".active").classList.remove("active");
            node.classList.add("active");

            const currentState = outputEditor.saveViewState();
            const currentModel = outputEditor.getModel();

            if (currentModel === data.pascaligo.model) {
              data.pascaligo.state = currentState;
            } else if (currentModel === data.output.state) {
              data.output.state = currentState;
            } else if (currentModel === data.logs.state) {
              data.logs.state = currentState;
            }

            outputEditor.setModel(data[node.id].model);
            outputEditor.restoreViewState(data[node.id].state);
          };
        });
      });
    </script>
  </body>
</html>
